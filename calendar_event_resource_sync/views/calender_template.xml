<?xml version="1.0" encoding="utf-8" ?>
<odoo>
    <data>
        <record id="website_menu_booking" model="website.menu">
            <field name="name">Booking</field>
            <field name="url">/booking</field>
            <field name="website_id" ref="website.default_website"/>
            <field name="parent_id" ref="website.main_menu"/>
            <field name="sequence" type="int">40</field>
        </record>

        <template id="booking_confirmation_template" name="Booking Confirmation Page">
            <t t-call="website.layout">
                <t t-if="error_message">
                    <script>
                        window.addEventListener("load", function() {
                        alert("Oops! Something went wrong:<t t-esc='error_message'/>");
                        });
                    </script>
                    <div class="container my-5">
                        <h1>Booking Failed ❌</h1>
                        <p class="text-danger">Your booking could not be scheduled due to an error.</p>
                        <a href="/booking" class="btn btn-danger mt-3">Go back to Booking Page</a>
                    </div>
                </t>
                <t t-else="">
                    <div class="container my-5">
                        <h1>Booking Scheduled ✅</h1>
                        <p>Your booking has been successfully scheduled.</p>
                        <ul>
                            <li>
                                <strong>From:</strong>
                                <t t-out="start"/>
                            </li>
                            <li>
                                <strong>To:</strong>
                                <t t-out="stop"/>
                            </li>
                            <li>
                                <strong>Booking Type:</strong>
                                <t t-out="booking_type_id"/>
                            </li>
                            <li>
                                <strong>Combination:</strong>
                                <t t-out="combination_id"/>
                            </li>
                        </ul>
                        <a href="/" class="btn btn-primary mt-3">Return to Home</a>
                    </div>
                </t>
            </t>
        </template>

        <template id="booking_template" name="Booking Page">
            <t t-call="website.layout">
                <div class="container my-5">
                    <h1>Book a Meeting</h1>
                    <div id="booking_wrapper" t-att-data-type-selected="selected_type or ''">
                        <form method="get" action="/booking" class="mb-4">
                            <div class="row g-3 align-items-end">
                                <!-- Booking Type -->
                                <div class="col-md-3 col-sm-6">
                                    <label class="form-label fw-semibold small text-start d-block">Booking Type</label>
                                    <select name="booking_type_id" class="form-select form-select-sm"
                                            onchange="this.form.submit()">
                                        <option value="">-- Select Booking Type --</option>
                                        <t t-foreach="booking_types" t-as="bt">
                                            <option t-att-value="bt.id"
                                                    t-att-selected="bt.id == selected_type and 'selected' or None"
                                                    t-out="bt.name"/>
                                        </t>
                                    </select>
                                </div>

                                <!-- Resource Combination -->
                                <div class="col-md-3 col-sm-6 ms-md-3">
                                    <label class="form-label fw-semibold small text-start d-block">Resource Combination
                                    </label>
                                    <select name="combination_id" class="form-select form-select-sm"
                                            onchange="this.form.submit()">
                                        <option value="">-- Select Combination --</option>
                                        <!-- Extra option for Auto Assign -->
                                        <option value="auto_assign"
                                                t-att-selected="selected_combo == 'auto_assign' and 'selected' or None">
                                            Auto Assign
                                        </option>
                                        <t t-foreach="combinations" t-as="combo">
                                            <option t-att-value="combo.id"
                                                    t-att-selected="combo.id == selected_combo and 'selected' or None"
                                                    t-out="combo.name"/>
                                        </t>
                                    </select>

                                </div>
                            </div>
                        </form>

                        <!--                     Calendar Container -->
                        <div id="calendar_container">
                            <t t-call="calendar_event_resource_sync.scheduling_calendar"/>
                        </div>
                    </div>
                </div>
                <!--                <script>-->
                <!--                    document.addEventListener("DOMContentLoaded", function() {-->
                <!--                        const wrapper = document.getElementById("booking_wrapper");-->
                <!--                        const typeSelected = wrapper.dataset.typeSelected;-->

                <!--                        document.querySelectorAll(".slots-dropdown button[data-bs-toggle='modal']").forEach(btn => {-->
                <!--                            if (!typeSelected) {-->
                <!--                                // Remove modal attributes so it doesn't open-->
                <!--                                btn.removeAttribute("data-bs-toggle");-->
                <!--                                btn.removeAttribute("data-bs-target");-->

                <!--                                // Add a click event to show alert-->
                <!--                                btn.addEventListener("click", function(event) {-->
                <!--                                    event.preventDefault();-->
                <!--                                    alert("Please select a booking type before selecting a slot.");-->
                <!--                                });-->
                <!--                            }-->
                <!--                        });-->
                <!--                    });-->
                <!--                </script>-->
                <script>
                    document.addEventListener("DOMContentLoaded", function() {
                    const wrapper = document.getElementById("booking_wrapper");
                    const typeSelected = wrapper.dataset.typeSelected;
                    const combinationSelected = document.querySelector("select[name='combination_id']").value;

                    document.querySelectorAll(".slots-dropdown button[data-bs-toggle='modal']").forEach(btn => {
                    if (!typeSelected || !combinationSelected || combinationSelected === "") {
                    // Remove modal attributes so it doesn't open
                    btn.removeAttribute("data-bs-toggle");
                    btn.removeAttribute("data-bs-target");

                    // Add a click event to show alert
                    btn.addEventListener("click", function(event) {
                    event.preventDefault();
                    alert("Please select a booking type and a resource combination before selecting a slot.");
                    });
                    }
                    });
                    });
                </script>

            </t>
        </template>

        <template id="scheduling_calendar" name="Resource Booking Calendar">
            <t t-call-assets="web.assets_frontend" t-js="false"/>
            <style>
                .o_booking_calendar .btn-primary {
                padding: 5px 10px;
                font-size: 15px;
                border-radius: 4px;
                }

                @media (max-width: 400px) {
                .o_booking_calendar .btn-primary {
                padding: 2px 5px;
                font-size: 8px;
                }
                }
            </style>
            <t t-set="confirm_url" t-value="'/scheduled'"/>
            <t t-set="date_format" t-value="res_lang.date_format"/>
            <t t-set="time_format" t-value="res_lang.time_format.replace(':%S', '')"/>
            <t t-set="start_next" t-value="start + relativedelta(months=1)"/>
            <t t-set="start_previous" t-value="start - relativedelta(months=1)"/>
            <div class="o_booking_calendar">
                <div class="alert alert-danger" t-if="not slots">
                    No free slots found this month.
                    <a t-attf-href="/booking?year={{ start_previous.year }}&amp;month={{ start_previous.month }}&amp;booking_type_id={{ selected_type }}&amp;combination_id={{ selected_combo }}"
                       class="alert-link"
                    >
                        Try next month
                        <i class="fa fa-chevron-right"/>
                    </a>

                </div>
                <!-- Monthly calendar -->
                <div class="table-responsive-md">
                    <table class="table text-center">
                        <thead class="thead-dark">
                            <tr>
                                <th class="text-left">
                                    <a t-attf-href="/booking?year={{ start_previous.year }}&amp;month={{ start_previous.month }}&amp;booking_type_id={{ selected_type }}&amp;combination_id={{ selected_combo }}"
                                       class="btn btn-secondary" title="Previous month">
                                        <i class="fa fa-chevron-left"/>
                                    </a>
                                </th>
                                <th
                                        class="align-middle"
                                        colspan="5"
                                        t-out="start.strftime('%B %Y')"
                                />
                                <th class="text-right">
                                    <a t-attf-href="/booking?year={{ start_next.year }}&amp;month={{ start_next.month }}&amp;booking_type_id={{ selected_type }}&amp;combination_id={{ selected_combo }}"
                                       class="btn btn-secondary" title="Next month">
                                        <i class="fa fa-chevron-right"/>
                                    </a>
                                </th>
                            </tr>
                        </thead>
                        <thead>
                            <tr>
                                <t t-foreach="calendar.iterweekdays()" t-as="weekday">
                                    <th
                                            t-att-title="weekday_names[str(weekday + 1)]"
                                            t-out="weekday_names[str(weekday + 1)][:3]"
                                    />
                                </t>
                            </tr>
                        </thead>
                        <tbody>
                            <t
                                    t-foreach="calendar.monthdatescalendar(start.year, start.month)"
                                    t-as="week"
                            >
                                <tr>
                                    <t t-foreach="week" t-as="day">
                                        <td
                                                t-att-class="day.month != start.month and 'text-muted'"
                                        >
                                            <t
                                                    t-if="day.month == start.month and slots.get(day)"
                                            >
                                                <!-- Day dropdown -->
                                                <div class="dropdown">
                                                    <button
                                                            class="btn btn-primary dropdown-toggle"
                                                            type="button"
                                                            data-bs-toggle="dropdown"
                                                            aria-haspopup="true"
                                                            aria-expanded="false"
                                                            t-out="day.day"
                                                            t-attf-id="dropdown-trigger-#{day.isoformat()}"
                                                    />
                                                    <div
                                                            class="dropdown-menu slots-dropdown"
                                                            t-attf-aria-labelledby="dropdown-trigger-#{day.isoformat()}"
                                                    >
                                                        <t
                                                                t-foreach="slots[day]"
                                                                t-as="slot"
                                                        >
                                                            <!-- Hour item to open confirmation -->
                                                            <button
                                                                    class="dropdown-item"
                                                                    type="button"
                                                                    data-bs-toggle="modal"
                                                                    t-attf-data-bs-target="#modal-confirm-#{int(slot.timestamp())}"
                                                                    t-out="slot.strftime(time_format)"
                                                            />
                                                        </t>
                                                    </div>
                                                </div>
                                            </t>
                                            <t t-else="">
                                                <t t-out="day.day"/>
                                            </t>
                                        </td>
                                    </t>
                                </tr>
                            </t>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td
                                        colspan="7"
                                >All times are displayed using this timezone:
                                    <strong t-out="selected_type_tz"/>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <!-- Hour confirmation modals -->
                <t
                        t-foreach="calendar.monthdatescalendar(start.year, start.month)"
                        t-as="week"
                >
                    <t t-foreach="week" t-as="day">
                        <form
                                t-foreach="slots.get(day, [])"
                                t-as="slot"
                                method="post"
                                t-att-action="confirm_url"
                                t-attf-id="modal-confirm-#{int(slot.timestamp())}"
                                t-attf-aria-labelledby="modal-title-#{int(slot.timestamp())}"
                                class="modal fade"
                        >
                            <input
                                    type="hidden"
                                    name="csrf_token"
                                    t-att-value="request.csrf_token()"
                            />
                            <input
                                    type="hidden"
                                    name="access_token"
                                    t-att-value="access_token"
                            />
                            <input
                                    type="hidden"
                                    name="when"
                                    t-att-value="slot.isoformat()"
                            />
                            <input type="hidden" name="booking_type_id" t-att-value="selected_type"/>
                            <input type="hidden" name="combination_id" t-att-value="selected_combo"/>
                            <input type="hidden" name="booking" t-att-value="int(booking.id)"/>
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div
                                            t-attf-id="modal-title-#{int(slot.timestamp())}"
                                            class="modal-header"
                                    >
                                        <h5>Confirm booking</h5>
                                    </div>
                                    <div class="modal-body">
                                        <p>You are about to confirm this booking:</p>
                                        <ul>
                                            <li>
                                                Start:
                                                <strong
                                                        t-out="slot.strftime(date_format)"
                                                />
                                                <strong
                                                        t-out="slot.strftime(time_format)"
                                                />
                                            </li>
                                            <li>
                                                Duration:
                                                <strong
                                                        t-field="booking.duration"
                                                        t-options='{"widget": "float_time"}'
                                                />
                                            </li>
                                        </ul>
                                        <p>Are you sure?</p>
                                    </div>
                                    <div class="modal-footer">
                                        <button
                                                type="button"
                                                class="btn btn-secondary"
                                                data-bs-dismiss="modal"
                                        >Cancel
                                        </button>
                                        <button
                                                type="submit"
                                                class="btn btn-primary"
                                        >Confirm booking
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </t>
                </t>
            </div>
        </template>
    </data>
</odoo>
